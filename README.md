# bq-query-result-downloader

BigQuery の Web UI でクエリを実行してファイルダウンロードしようとすると、16000行で強制的にカットされてしまう。  
それ以上のデータをダウンロードするには 1.BQにクエリ結果のテーブルを作る → 2.そのテーブルからGCSにCSVでエクスポートする → 3.GCSからローカルにダウンロードする という手順を踏まなければならない。

このスクリプトは上記を簡略化し、クエリ実行 → データをストリームでダウンロード → ローカルにCSVとJSONファイルを生成 をコマンド一発で実現する。

またクエリ実行前に概算コストが表示され、そこで5秒待機するのでその間は Ctrl + C によるキャンセルができる。

## 準備
```
$ yarn install
```

- `query` ディレクトリにBigQueryで実行するSQLを記述したファイルを置く。
- ディレクトリをスキャンして対象ファイルが1つだけの場合に処理が実行される。
- ファイル名の先頭が `_` で始まる場合はスキャンスキップ対象になる。

## 実行
```
$ yarn start
```

処理が完了すると `results` ディレクトリに `result_1538058439.{json,csv}` のようなファイルが生成される。

## 実行 (生成されるファイル名を指定する)
```
$ yarn start hogehoge
```

処理が完了すると `results` ディレクトリに `hogehoge_1538058439.{json,csv}` のようなファイルが生成される。

## オプション設定

デフォルト設定を変更したい場合は、 `README.md` と同じ階層に `.config.json` ファイルを作り、下記をコピーする。

```json
{
  "bigQuery": {
    "location": "US",
    "maxResults": 5000
  },
  "dollarYenRate": 113
}
```

`maxResults` ... 一度にダウンロードする行数。`5000`に設定した場合、合計10,000行なら2回に分けてダウンロードする。
